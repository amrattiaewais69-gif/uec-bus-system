<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Bus QR Scanner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
font-family:Arial, sans-serif;
background:#0f172a;
color:white;
text-align:center;
margin:0;
padding:0;
}

.card{
background:#1e293b;
padding:20px;
margin:20px auto;
width:90%;
max-width:450px;
border-radius:15px;
box-shadow:0 0 20px rgba(0,0,0,0.4);
}

input{
width:90%;
padding:10px;
margin:10px 0;
border-radius:8px;
border:none;
font-size:16px;
}

button{
padding:10px 20px;
border:none;
border-radius:8px;
background:#22c55e;
color:white;
font-size:16px;
cursor:pointer;
}

button:disabled{
opacity:0.6;
cursor:not-allowed;
}

#reader{
width:100%;
margin-top:15px;
}

.success{color:#22c55e;font-weight:bold;}
.error{color:#ef4444;font-weight:bold;}
.processing{color:#facc15;font-weight:bold;}

.spinner{
border:4px solid rgba(255,255,255,0.2);
border-top:4px solid #facc15;
border-radius:50%;
width:40px;
height:40px;
margin:10px auto;
animation:spin 1s linear infinite;
}

@keyframes spin{
0%{transform:rotate(0deg);}
100%{transform:rotate(360deg);}
}
</style>
</head>

<body>

<div class="card" id="loginCard">
<h2>Start Route</h2>
<input type="text" id="driver" placeholder="Driver Name">
<input type="text" id="bus" placeholder="Bus Number">
<button onclick="startRoute()">Start</button>
</div>

<div class="card" id="scannerCard" style="display:none;">
<h2>QR Scanner</h2>
<div id="summary"></div>
<div id="counter">Passengers: 0</div>
<div id="reader"></div>
<div id="statusBox">Ready to scan...</div>
<button id="closeBtn" onclick="closeRoute()" style="background:#ef4444;margin-top:15px;">
Close Route
</button>
</div>

<script>
let driverName="";
let busNumber="";
let studentCount=0;
let qr=null;
let processingLock=false;

const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzlT8RGcQtHVOWjshn1H5BZyi78B0DgUhtL4ahpS9JXlgTuKMjzSWcQVYm05AaIxx0KcQ/exec";

const beep=new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

function startRoute(){

driverName=document.getElementById("driver").value.trim();
busNumber=document.getElementById("bus").value.trim();

if(!driverName||!busNumber){
alert("Enter Driver & Bus Number");
return;
}

let startTime=new Date().toLocaleTimeString();

document.getElementById("loginCard").style.display="none";
document.getElementById("scannerCard").style.display="block";

document.getElementById("summary").innerHTML=
"Driver: "+driverName+
"<br>Bus: "+busNumber+
"<br>Start Time: "+startTime;

initializeScanner();
}

async function initializeScanner(){

if(qr){
try{ await qr.clear(); }catch(e){}
}

qr=new Html5Qrcode("reader");
processingLock=false;

qr.start(
{facingMode:"environment"},
{fps:10,qrbox:250},
onScanSuccess
);

document.getElementById("statusBox").className="";
document.getElementById("statusBox").innerHTML="Ready to scan...";
}

async function onScanSuccess(decodedText){

if(processingLock) return;
processingLock=true;

try{
await qr.stop();
await qr.clear();
}catch(e){}

showProcessingScreen();
await sendScan(decodedText);
}

function showProcessingScreen(){
document.getElementById("reader").style.display="none";

let box=document.getElementById("statusBox");
box.className="processing";
box.innerHTML=`
<div class='spinner'></div>
<div>Processing on server...</div>
<div style="direction:rtl;margin-top:5px;">
ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...
</div>
`;
}

async function sendScan(id){

try{

const response=await fetch(SCRIPT_URL,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
id:id,
driver:driverName,
bus:busNumber,
timestamp:Date.now()
})
});

const data=await response.json();
handleResponse(data);

}catch(e){
handleNetworkError();
}
}

function handleResponse(data){

let box=document.getElementById("statusBox");
let message="";

if(data.status==="approved"){

studentCount++;
document.getElementById("counter").innerText="Passengers: "+studentCount;

message=`
<div>‚úÖ ${data.name} Approved</div>
<div>${data.routeType}</div>
<div style="direction:rtl;margin-top:5px;">
ÿ™ŸÖ ŸÇÿ®ŸàŸÑ ÿßŸÑÿ∑ÿßŸÑÿ®
</div>
`;

box.className="success";
beep.play();
if(navigator.vibrate) navigator.vibrate(150);
playVoice(data.name);

}
else if(data.status==="not_registered"){

message=`
<div>üö´ Not Registered</div>
<div style="direction:rtl;margin-top:5px;">
ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸÑ
</div>
`;

box.className="error";
}
else if(data.status==="out_of_time"){

message=`
<div>‚è∞ Outside Allowed Time</div>
<div style="direction:rtl;margin-top:5px;">
ÿÆÿßÿ±ÿ¨ ŸàŸÇÿ™ ÿßŸÑÿ±ÿ≠ŸÑÿ©
</div>
`;

box.className="error";
}
else{
message="<div>Unexpected Response</div>";
box.className="error";
}

box.innerHTML=message;

setTimeout(()=>{
restartScanner();
},2000);
}

function handleNetworkError(){

let box=document.getElementById("statusBox");

box.className="error";
box.innerHTML=`
<div>‚ö† Network Error</div>
<div style="direction:rtl;margin-top:5px;">
ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ¥ÿ®ŸÉÿ©
</div>
`;

setTimeout(()=>{
restartScanner();
},2000);
}

function restartScanner(){
document.getElementById("reader").style.display="block";
initializeScanner();
}

async function closeRoute(){

document.getElementById("closeBtn").disabled=true;

try{

await fetch(SCRIPT_URL,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
action:"close_route"
})
});

}catch(e){}

if(qr){
try{
await qr.stop();
await qr.clear();
}catch(e){}
}

document.getElementById("scannerCard").innerHTML=
"<h2 style='color:#22c55e'>Route Closed Successfully</h2>"+
"<p>Total Passengers: "+studentCount+"</p>";
}

function playVoice(name){

const msg=new SpeechSynthesisUtterance(
"Welcome "+name+". You are approved for boarding."
);

msg.lang="en-US";
msg.rate=0.9;

speechSynthesis.speak(msg);
}
</script>

</body>
</html>
