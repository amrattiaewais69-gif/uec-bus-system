<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Bus QR Scanner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
font-family:Arial;
background:linear-gradient(135deg,#0f172a,#1e293b);
color:white;
text-align:center;
margin:0;
padding:0;
}

.card{
background:#111827;
padding:25px;
margin:25px auto;
width:90%;
max-width:420px;
border-radius:18px;
box-shadow:0 0 25px rgba(212,175,55,0.3);
border:1px solid #d4af37;
}

h2{
color:#d4af37;
margin-bottom:15px;
}

input{
width:90%;
padding:12px;
margin:10px 0;
border-radius:10px;
border:none;
font-size:16px;
background:#1e293b;
color:white;
}

button{
padding:12px 20px;
border:none;
border-radius:10px;
background:#d4af37;
color:black;
font-size:16px;
cursor:pointer;
font-weight:bold;
}

button:hover{
background:#facc15;
}

#reader{
margin-top:15px;
}

#counter{
margin-top:10px;
font-size:18px;
color:#facc15;
}

.success{color:#22c55e;font-weight:bold;font-size:18px;}
.error{color:#ef4444;font-weight:bold;font-size:18px;}
.processing{color:#facc15;font-weight:bold;font-size:18px;}

.spinner{
border:4px solid rgba(255,255,255,0.2);
border-top:4px solid #d4af37;
border-radius:50%;
width:45px;
height:45px;
margin:15px auto;
animation:spin 1s linear infinite;
}

@keyframes spin{
0%{transform:rotate(0deg);}
100%{transform:rotate(360deg);}
}
</style>
</head>

<body>

<div class="card" id="loginCard">
<h2>Start Route</h2>
<input type="text" id="driver" placeholder="Driver Name">
<input type="text" id="bus" placeholder="Bus Number">
<button onclick="startRoute()">Start</button>
</div>

<div class="card" id="scannerCard" style="display:none;">
<h2>QR Scanner</h2>
<div id="summary"></div>
<div id="counter">Passengers: 0</div>
<div id="reader"></div>
<div id="statusBox">Ready to scan...</div>
<button onclick="closeRoute()" style="background:#ef4444;margin-top:15px;">Close Route</button>
</div>

<script>

let driverName="";
let busNumber="";
let studentCount=0;
let qr=null;
let processingLock=false;

const beep=new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

/* START ROUTE */

function startRoute(){

driverName=document.getElementById("driver").value.trim();
busNumber=document.getElementById("bus").value.trim();

if(!driverName||!busNumber){
alert("Enter Driver & Bus Number");
return;
}

document.getElementById("loginCard").style.display="none";
document.getElementById("scannerCard").style.display="block";

document.getElementById("summary").innerHTML=
"Driver: "+driverName+
"<br>Bus: "+busNumber+
"<br>Start Time: "+new Date().toLocaleTimeString();

initializeScanner();
}

/* INITIALIZE SCANNER */

async function initializeScanner(){

if(qr){
try{await qr.clear();}catch(e){}
}

qr=new Html5Qrcode("reader");
processingLock=false;

qr.start(
{facingMode:"environment"},
{fps:10,qrbox:250},
onScanSuccess
);

document.getElementById("statusBox").innerHTML="Ready to scan...";
}

/* ON SCAN */

async function onScanSuccess(decodedText){

if(processingLock) return;
processingLock=true;

try{
await qr.stop();
await qr.clear();
}catch(e){}

showProcessing();
await sendData(decodedText);
}

/* PROCESSING */

function showProcessing(){

document.getElementById("reader").style.display="none";

document.getElementById("statusBox").className="processing";
document.getElementById("statusBox").innerHTML=
"<div class='spinner'></div>"+
"Processing...<br><div style='direction:rtl'>ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©</div>";
}

/* SEND DATA */

async function sendData(id){

try{

const response=await fetch("https://script.google.com/macros/s/AKfycbzlT8RGcQtHVOWjshn1H5BZyi78B0DgUhtL4ahpS9JXlgTuKMjzSWcQVYm05AaIxx0KcQ/exec",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
id:id,
driver:driverName,
bus:busNumber
})
});

/* IMPORTANT CHECK */
if(!response.ok){
throw new Error("Server error");
}

const data=await response.json();

handleResponse(data);

}catch(error){
console.error("Fetch error:",error);
handleNetworkError();
}

}

/* HANDLE RESPONSE */

function handleResponse(data){

let box=document.getElementById("statusBox");

if(data.status==="approved"){

studentCount++;
document.getElementById("counter").innerText="Passengers: "+studentCount;

box.className="success";
box.innerHTML="‚úÖ "+(data.name||"Student")+" Approved";

beep.play();

}
else if(data.status==="already_used"){

box.className="error";
box.innerHTML="‚ùå Already Used";

}
else{

box.className="error";
box.innerHTML="üö´ Not Registered";

}

setTimeout(restartScanner,2000);
}

/* NETWORK ERROR */

function handleNetworkError(){

let box=document.getElementById("statusBox");
box.className="error";
box.innerHTML="‚ö† Server Connection Failed";

setTimeout(restartScanner,2000);
}

/* RESTART */

function restartScanner(){
document.getElementById("reader").style.display="block";
initializeScanner();
}

/* CLOSE ROUTE */

async function closeRoute(){

if(qr){
try{
await qr.stop();
await qr.clear();
}catch(e){}
}

document.getElementById("scannerCard").innerHTML=
"<h2 style='color:#d4af37'>Route Closed</h2>"+
"<p>Total Passengers: "+studentCount+"</p>";
}

</script>

</body>
</html>
